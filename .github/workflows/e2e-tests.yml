name: E2E COA Validation Test
on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 16 * * *' # í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë§¤ì¼ ìƒˆë²½ 1ì‹œ

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰. continue-on-error: trueëŠ” í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ê³„ì† ì§„í–‰í•˜ê²Œ í•©ë‹ˆë‹¤.
      - name: Run Playwright tests
        id: playwright_test
        continue-on-error: true
        env:
          ADEKA_ID: ${{ secrets.ADEKA_ID }}
          ADEKA_PASSWORD: ${{ secrets.ADEKA_PASSWORD }}
          BASE_URL: 'https://spc.adkk.co.kr:8091'
          CI: true
        run: npx playwright test

      # [ì¶”ê°€ë¨] í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ë° ì´ìŠˆ ë³¸ë¬¸ ìƒì„±
      - name: Summarize results and create issue body
        id: summarize
        if: always() # í…ŒìŠ¤íŠ¸ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        run: |
          node -e "
            const fs = require('fs');
            const summaryPath = 'test-results/summary.json';
            if (!fs.existsSync(summaryPath)) {
              console.log('í…ŒìŠ¤íŠ¸ ìš”ì•½ íŒŒì¼(summary.json)ì´ ì—†ìŠµë‹ˆë‹¤.');
              fs.writeFileSync('issue-body.md', 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ìš”ì•½ íŒŒì¼ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
              return;
            }
            const results = JSON.parse(fs.readFileSync(summaryPath, 'utf-8'));
            const total = results.length;
            const failures = results.filter(r => r.status === 'failure');
            const successCount = total - failures.length;
            const successRate = total > 0 ? (successCount / total * 100).toFixed(2) : '100.00';

            let summary = '## ğŸ“ˆ E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½\\n\\n';
            summary += `- **ì´ LOT ìˆ˜:** ${total}ê°œ\\n`;
            summary += `- **ì„±ê³µ:** ${successCount}ê°œ\\n`;
            summary += `- **ì‹¤íŒ¨:** ${failures.length}ê°œ\\n`;
            summary += `- **ì„±ê³µë¥ :** ${successRate}%\\n\\n`;

            if (failures.length > 0) {
              summary += '### âŒ ì‹¤íŒ¨ í•­ëª© ìƒì„¸\\n\\n';
              summary += '| ì œí’ˆëª… | LOT ë²ˆí˜¸ | ì‹¤íŒ¨ ì‚¬ìœ  |\\n';
              summary += '|---|---|---|\\n';
              failures.forEach(f => {
                const errorMsg = f.error.replace(/\\n/g, ' ').replace(/\\u001b\\[[0-9;]*m/g, '');
                summary += `| ${f.productName} | ${f.lotNumber} | ${errorMsg} |\\n`;
              });
              fs.writeFileSync('issue-body.md', summary);
            }
            
            console.log(summary.replace(/\\n/g, '\n'));
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary.replace(/\\n/g, '\n'));
          "
      
      # [ì¶”ê°€ë¨] í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ GitHub ì´ìŠˆ ìƒì„±
      - name: Create GitHub Issue on Failure
        if: steps.playwright_test.outcome == 'failure' # 'Run Playwright tests' ë‹¨ê³„ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ì‹¤í–‰
        uses: actions-ecosystem/action-create-issue@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸš¨ [ìë™í™” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨] COA ê²€ì¦ ì˜¤ë¥˜ ë°œìƒ"
          body_path: ./issue-body.md
          labels: |
            bug
            automated-test
            
      # [ì¶”ê°€ë¨] í…ŒìŠ¤íŠ¸ ìµœì¢… ìƒíƒœ í™•ì¸
      - name: Check test status
        if: steps.playwright_test.outcome == 'failure'
        run: exit 1 # í…ŒìŠ¤íŠ¸ ë‹¨ê³„ê°€ ì‹¤íŒ¨í–ˆë‹¤ë©´ ì›Œí¬í”Œë¡œìš° ì „ì²´ë¥¼ ì‹¤íŒ¨ ì²˜ë¦¬

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-and-failures
          path: |
            playwright-report/
            test-results/
          