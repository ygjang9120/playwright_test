name: ADEKA-COA Schedule Test
on:
  workflow_dispatch:
    inputs:
      grep:
        description: 'Playwright ADEKA COA í…ŒìŠ¤íŠ¸'
        required: false
        default: ''
  # schedule:
  #   - cron: '0 8 * * *'

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰. ì´ì œ ì´ ë‹¨ê³„ ì•ˆì—ì„œ í…”ë ˆê·¸ë¨ ì•Œë¦¼ì´ ìë™ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.
      - name: Run Playwright tests
        id: playwright_test
        continue-on-error: true
        env:
          ADEKA_ID: ${{ secrets.ADEKA_ID }}
          ADEKA_PASSWORD: ${{ secrets.ADEKA_PASSWORD }}
          BASE_URL: 'https://spc.adkk.co.kr:8091'
          # âœ¨ í…”ë ˆê·¸ë¨ ì‹œí¬ë¦¿ì„ í…ŒìŠ¤íŠ¸ ì½”ë“œë¡œ ì „ë‹¬í•˜ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          CI: true
        run: npx playwright test

      # (ì´ìŠˆ ë³¸ë¬¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ëŠ” í•„ìš”ì‹œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
      - name: Summarize results and create issue body
        id: summarize
        if: always()
        run: node scripts/generate-issue-body.js

      # â–¼â–¼â–¼ ì•„ë˜ 2ê°œì˜ í…”ë ˆê·¸ë¨ ì•Œë¦¼ ë¸”ë¡ì€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤ â–¼â–¼â–¼
      # - name: Notify Telegram - Success ... (ì‚­ì œ)
      # - name: Notify Telegram - Failure ... (ì‚­ì œ)

      # í…ŒìŠ¤íŠ¸ ì „ì²´ ì‹¤í–‰ ì¤‘ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ GitHub ì´ìŠˆë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì€ ìœ ìš©í•˜ë¯€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
      - name: Create GitHub Issue on Failure
        if: steps.playwright_test.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸš¨ [ìë™í™” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨] COA ê²€ì¦ ì˜¤ë¥˜ ë°œìƒ (${{ github.run_number }})"
          content-filepath: ./issue-body.md
          labels: |
            bug
            automated-test
      
      # í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ì™€ ê²°ê³¼ë¬¼ì€ í•­ìƒ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-and-failures
          path: |
            playwright-report/
            test-results/
            issue-body.md
            downloads/ 
          retention-days: 7

      # í…ŒìŠ¤íŠ¸ ë‹¨ê³„ê°€ ì „ì²´ì ìœ¼ë¡œ ì‹¤íŒ¨í–ˆë‹¤ë©´ ì›Œí¬í”Œë¡œìš°ë„ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
      - name: Check test status
        if: steps.playwright_test.outcome == 'failure'
        run: exit 1