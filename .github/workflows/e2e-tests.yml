name: ADEKA-COA Schedule Test
on:
 workflow_dispatch:
    inputs:
      grep:
        description: 'Playwright ADEKA COA í…ŒìŠ¤íŠ¸'
        required: false
        default: ''
  # schedule:
    
  #   - cron: '0 8 * * *'

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰. continue-on-error: trueëŠ” í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ê³„ì† ì§„í–‰í•˜ê²Œ í•©ë‹ˆë‹¤.
      - name: Run Playwright tests
        id: playwright_test
        continue-on-error: true
        env:
          ADEKA_ID: ${{ secrets.ADEKA_ID }}
          ADEKA_PASSWORD: ${{ secrets.ADEKA_PASSWORD }}
          BASE_URL: 'https://spc.adkk.co.kr:8091'
          CI: true
        # ì¤‘ìš”: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½(summary.json)ì„ ìƒì„±í•˜ë„ë¡ playwright.config.tsì— ì„¤ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        run: npx playwright test

      # [ìˆ˜ì •ë¨] ë³„ë„ì˜ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì„ ì‹¤í–‰í•˜ì—¬ ê²°ê³¼ ìš”ì•½ ë° ì´ìŠˆ ë³¸ë¬¸ ìƒì„±
      - name: Summarize results and create issue body
        id: summarize
        if: always() # í…ŒìŠ¤íŠ¸ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        run: node scripts/generate-issue-body.js

      # --- ì„±ê³µ ì•Œë¦¼ ---
      - name: Notify Telegram - Success
        if: steps.playwright_test.outcome == 'success'
        run: |
          # success-message.txt íŒŒì¼ì˜ ë‚´ìš©ì„ ì½ì–´ MSG ë³€ìˆ˜ì— ì €ì¥
          MSG=$(cat test-results/success-message.txt)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_THREAD_ID }}" \
            -d parse_mode=HTML \
            --data-urlencode "text=${MSG}"

      # [ê¸°ì¡´ê³¼ ë™ì¼] í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ GitHub ì´ìŠˆ ìƒì„±
      - name: Create GitHub Issue on Failure
        if: steps.playwright_test.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸš¨ [ìë™í™” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨] COA ê²€ì¦ ì˜¤ë¥˜ ë°œìƒ (${{ github.run_number }})"
          content-filepath: ./issue-body.md
          labels: |
            bug
            automated-test
      
      - name: Notify Telegram - Failure
        if: steps.playwright_test.outcome == 'failure'
        run: |
          # 1. summary.json íŒŒì¼ì—ì„œ ì‹¤íŒ¨í•œ í•­ëª©ë§Œ ì¶”ì¶œí•˜ì—¬ jqë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
          FAILURE_LIST=$(jq -r '.[] | select(.status=="failure") | "  - ì œí’ˆ: \(.productName), LOT: \(.lotNumber)"' test-results/summary.json)
          
          # 2. ì‹¤íŒ¨ ê±´ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
          # grep -c . ì€ ë¹„ì–´ìˆì§€ ì•Šì€ ë¼ì¸ì˜ ìˆ˜ë¥¼ ì…‰ë‹ˆë‹¤.
          FAILURE_COUNT=$(echo "${FAILURE_LIST}" | grep -c .)
          
          # 3. ì „ì²´ ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
          FAILURE_DETAILS="âŒ COA ì—ëŸ¬ ë°œìƒ (${FAILURE_COUNT}ê±´)\n${FAILURE_LIST}"
          
          # 4. í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì „ì†¡í•  ìµœì¢… ë©”ì‹œì§€ë¥¼ ë§Œë“­ë‹ˆë‹¤.
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MSG="<b>${FAILURE_DETAILS}</b>\n\n<a href=\"${RUN_URL}\">#${{ github.run_number }} ì‹¤í–‰ ë¡œê·¸/ë¦¬í¬íŠ¸ í™•ì¸</a>"
          
          # 5. curlë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_THREAD_ID }}" \
            -d parse_mode=HTML \
            --data-urlencode "text=${MSG}"

      # [ê¸°ì¡´ê³¼ ë™ì¼] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-and-failures
          path: |
            playwright-report/
            test-results/
            issue-body.md
            downloads/ 
          retention-days: 7

      # [ê¸°ì¡´ê³¼ ë™ì¼] í…ŒìŠ¤íŠ¸ ìµœì¢… ìƒíƒœ í™•ì¸
      - name: Check test status
        if: steps.playwright_test.outcome == 'failure'
        run: exit 1 # í…ŒìŠ¤íŠ¸ ë‹¨ê³„ê°€ ì‹¤íŒ¨í–ˆë‹¤ë©´ ì›Œí¬í”Œë¡œìš° ì „ì²´ë¥¼ ì‹¤íŒ¨ ì²˜ë¦¬
