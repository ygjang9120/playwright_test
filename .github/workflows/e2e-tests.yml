name: ADEKA-COA Schedule Test
on:
 workflow_dispatch:
    inputs:
      grep:
        description: 'Playwright ADEKA COA 테스트'
        required: false
        default: ''
  # schedule:
    
  #   - cron: '0 8 * * *'

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # 테스트 실행. continue-on-error: true는 테스트가 실패해도 다음 단계를 계속 진행하게 합니다.
      - name: Run Playwright tests
        id: playwright_test
        continue-on-error: true
        env:
          ADEKA_ID: ${{ secrets.ADEKA_ID }}
          ADEKA_PASSWORD: ${{ secrets.ADEKA_PASSWORD }}
          BASE_URL: 'https://spc.adkk.co.kr:8091'
          CI: true
        # 중요: 테스트 결과 요약(summary.json)을 생성하도록 playwright.config.ts에 설정이 필요할 수 있습니다.
        run: npx playwright test

      # [수정됨] 별도의 스크립트 파일을 실행하여 결과 요약 및 이슈 본문 생성
      - name: Summarize results and create issue body
        id: summarize
        if: always() # 테스트 성공/실패 여부와 관계없이 항상 실행
        run: node scripts/generate-issue-body.js

      # --- 성공 알림 ---
      - name: Notify Telegram - Success
        if: steps.playwright_test.outcome == 'success'
        run: |
          # success-message.txt 파일의 내용을 읽어 MSG 변수에 저장
          MSG=$(cat test-results/success-message.txt)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_THREAD_ID }}" \
            -d parse_mode=HTML \
            --data-urlencode "text=${MSG}"

      # [기존과 동일] 테스트 실패 시 GitHub 이슈 생성
      - name: Create GitHub Issue on Failure
        if: steps.playwright_test.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "🚨 [자동화 테스트 실패] COA 검증 오류 발생 (${{ github.run_number }})"
          content-filepath: ./issue-body.md
          labels: |
            bug
            automated-test
      
      - name: Notify Telegram - Failure
        if: steps.playwright_test.outcome == 'failure'
        run: |
          # 1. summary.json 파일에서 실패한 항목만 추출하여 jq로 포맷팅합니다.
          FAILURE_LIST=$(jq -r '.[] | select(.status=="failure") | "  - 제품: \(.productName), LOT: \(.lotNumber)"' test-results/summary.json)
          
          # 2. 실패 건수를 계산합니다.
          # grep -c . 은 비어있지 않은 라인의 수를 셉니다.
          FAILURE_COUNT=$(echo "${FAILURE_LIST}" | grep -c .)
          
          # 3. 전체 실패 메시지를 구성합니다.
          FAILURE_DETAILS="❌ COA 에러 발생 (${FAILURE_COUNT}건)\n${FAILURE_LIST}"
          
          # 4. 텔레그램으로 전송할 최종 메시지를 만듭니다.
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MSG="<b>${FAILURE_DETAILS}</b>\n\n<a href=\"${RUN_URL}\">#${{ github.run_number }} 실행 로그/리포트 확인</a>"
          
          # 5. curl로 메시지를 전송합니다.
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_THREAD_ID }}" \
            -d parse_mode=HTML \
            --data-urlencode "text=${MSG}"

      # [기존과 동일] 아티팩트 업로드
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-and-failures
          path: |
            playwright-report/
            test-results/
            issue-body.md
            downloads/ 
          retention-days: 7

      # [기존과 동일] 테스트 최종 상태 확인
      - name: Check test status
        if: steps.playwright_test.outcome == 'failure'
        run: exit 1 # 테스트 단계가 실패했다면 워크플로우 전체를 실패 처리
